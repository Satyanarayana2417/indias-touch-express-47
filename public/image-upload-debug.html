<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h2 {
            color: #333;
            margin-top: 0;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîß Image Upload Debug Tool</h1>
    <p>This tool helps diagnose image upload issues in the admin panel.</p>

    <div class="debug-section">
        <h2>üîç System Status Check</h2>
        <button class="test-button" onclick="checkSystemStatus()">Check System Status</button>
        <div id="systemStatus"></div>
    </div>

    <div class="debug-section">
        <h2>üî• Firebase Connection Test</h2>
        <button class="test-button" onclick="testFirebaseConnection()">Test Firebase</button>
        <div id="firebaseStatus"></div>
    </div>

    <div class="debug-section">
        <h2>üë§ Authentication Test</h2>
        <button class="test-button" onclick="testAuthentication()">Check Auth Status</button>
        <button class="test-button" onclick="testAdminRole()">Check Admin Role</button>
        <div id="authStatus"></div>
    </div>

    <div class="debug-section">
        <h2>‚òÅÔ∏è Firebase Functions Test</h2>
        <div class="input-group">
            <label for="testUrl">Test Image URL:</label>
            <input type="url" id="testUrl" placeholder="https://example.com/image.jpg" 
                   value="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800">
        </div>
        <button class="test-button" onclick="testUrlUpload()">Test URL Upload</button>
        <div id="functionsStatus"></div>
    </div>

    <div class="debug-section">
        <h2>üìÅ File Upload Test</h2>
        <div class="input-group">
            <label for="testFile">Select Image File:</label>
            <input type="file" id="testFile" accept="image/*">
        </div>
        <button class="test-button" onclick="testFileUpload()">Test File Upload</button>
        <div id="fileUploadStatus"></div>
    </div>

    <div class="debug-section">
        <h2>üìä Debug Log</h2>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        <div id="debugLog" class="log-output"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEkab3ZHAuNdGE4m51QSha_Sg0U9Ujovw",
            authDomain: "venkat-express-c95bb.firebaseapp.com",
            projectId: "venkat-express-c95bb",
            storageBucket: "venkat-express-c95bb.firebasestorage.app",
            messagingSenderId: "470308597",
            appId: "1:47030859957:web:64f32a02068cd474e2a6fc",
            measurementId: "G-9M8WCYN8NC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        // Make Firebase services globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseFunctions = functions;

        // Debug logging function
        window.debugLog = function(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeColor = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            logDiv.innerHTML += `<span style="color: ${typeColor}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        };

        window.debugLog('üöÄ Firebase Debug Tool Initialized', 'success');

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.debugLog(`‚úÖ User authenticated: ${user.email}`, 'success');
            } else {
                window.debugLog('‚ùå No user authenticated', 'error');
            }
        });

        // System status check function
        window.checkSystemStatus = function() {
            const statusDiv = document.getElementById('systemStatus');
            window.debugLog('üîç Checking system status...');
            
            const checks = [];
            
            // Check if Firebase is initialized
            if (window.firebaseApp) {
                checks.push('<span class="status-ok">‚úÖ Firebase App initialized</span>');
            } else {
                checks.push('<span class="status-error">‚ùå Firebase App not initialized</span>');
            }
            
            // Check services
            const services = [
                { name: 'Auth', service: window.firebaseAuth },
                { name: 'Firestore', service: window.firebaseDb },
                { name: 'Storage', service: window.firebaseStorage },
                { name: 'Functions', service: window.firebaseFunctions }
            ];
            
            services.forEach(({ name, service }) => {
                if (service) {
                    checks.push(`<span class="status-ok">‚úÖ ${name} service ready</span>`);
                } else {
                    checks.push(`<span class="status-error">‚ùå ${name} service not available</span>`);
                }
            });
            
            statusDiv.innerHTML = checks.join('<br>');
            window.debugLog('System status check completed');
        };

        // Firebase connection test
        window.testFirebaseConnection = async function() {
            const statusDiv = document.getElementById('firebaseStatus');
            window.debugLog('üî• Testing Firebase connection...');
            
            try {
                // Test Firestore connection
                const testDoc = doc(db, 'test', 'connection');
                await getDoc(testDoc);
                
                statusDiv.innerHTML = '<span class="status-ok">‚úÖ Firebase connection successful</span>';
                window.debugLog('‚úÖ Firebase connection test passed', 'success');
            } catch (error) {
                statusDiv.innerHTML = `<span class="status-error">‚ùå Firebase connection failed: ${error.message}</span>`;
                window.debugLog(`‚ùå Firebase connection failed: ${error.message}`, 'error');
            }
        };

        // Authentication test
        window.testAuthentication = function() {
            const statusDiv = document.getElementById('authStatus');
            const user = auth.currentUser;
            
            if (user) {
                statusDiv.innerHTML = `
                    <span class="status-ok">‚úÖ User authenticated</span><br>
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>UID:</strong> ${user.uid}
                `;
                window.debugLog(`‚úÖ User authenticated: ${user.email}`, 'success');
            } else {
                statusDiv.innerHTML = '<span class="status-error">‚ùå No user authenticated. Please login first.</span>';
                window.debugLog('‚ùå No user authenticated', 'error');
            }
        };

        // Admin role test
        window.testAdminRole = async function() {
            const user = auth.currentUser;
            if (!user) {
                window.debugLog('‚ùå Cannot check admin role - not authenticated', 'error');
                return;
            }
            
            try {
                window.debugLog('üëë Checking admin role...');
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const role = userData.role;
                    
                    if (role === 'admin') {
                        document.getElementById('authStatus').innerHTML += '<br><span class="status-ok">‚úÖ User has admin role</span>';
                        window.debugLog('‚úÖ User has admin role', 'success');
                    } else {
                        document.getElementById('authStatus').innerHTML += '<br><span class="status-error">‚ùå User does not have admin role</span>';
                        window.debugLog(`‚ùå User role: ${role || 'none'}`, 'error');
                    }
                } else {
                    document.getElementById('authStatus').innerHTML += '<br><span class="status-error">‚ùå User document not found in Firestore</span>';
                    window.debugLog('‚ùå User document not found', 'error');
                }
            } catch (error) {
                window.debugLog(`‚ùå Error checking admin role: ${error.message}`, 'error');
            }
        };

        // URL upload test
        window.testUrlUpload = async function() {
            const statusDiv = document.getElementById('functionsStatus');
            const testUrl = document.getElementById('testUrl').value;
            
            if (!testUrl) {
                window.debugLog('‚ùå Please enter a test URL', 'error');
                return;
            }
            
            window.debugLog(`üåê Testing URL upload: ${testUrl}`);
            statusDiv.innerHTML = '<span class="status-warning">‚è≥ Testing URL upload...</span>';
            
            try {
                const fetchImageFromUrl = httpsCallable(functions, 'fetchImageFromUrl');
                const result = await fetchImageFromUrl({
                    imageUrl: testUrl,
                    productId: 'test-product'
                });
                
                if (result.data.success) {
                    statusDiv.innerHTML = `<span class="status-ok">‚úÖ URL upload successful</span><br>
                        <strong>Cloudinary URL:</strong> <a href="${result.data.cloudinaryUrl}" target="_blank">${result.data.cloudinaryUrl}</a>`;
                    window.debugLog('‚úÖ URL upload test passed', 'success');
                } else {
                    statusDiv.innerHTML = `<span class="status-error">‚ùå URL upload failed: ${result.data.error}</span>`;
                    window.debugLog(`‚ùå URL upload failed: ${result.data.error}`, 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="status-error">‚ùå URL upload error: ${error.message}</span>`;
                window.debugLog(`‚ùå URL upload error: ${error.message}`, 'error');
            }
        };

        // File upload test
        window.testFileUpload = async function() {
            const statusDiv = document.getElementById('fileUploadStatus');
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            
            if (!file) {
                window.debugLog('‚ùå Please select a file', 'error');
                return;
            }
            
            window.debugLog(`üìÅ Testing file upload: ${file.name}`);
            statusDiv.innerHTML = '<span class="status-warning">‚è≥ Testing file upload...</span>';
            
            try {
                // Create a storage reference
                const storageRef = ref(storage, `test-uploads/${Date.now()}-${file.name}`);
                
                // Upload file
                const snapshot = await uploadBytes(storageRef, file);
                
                // Get download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                statusDiv.innerHTML = `<span class="status-ok">‚úÖ File upload successful</span><br>
                    <strong>Firebase URL:</strong> <a href="${downloadURL}" target="_blank">${downloadURL}</a>`;
                window.debugLog('‚úÖ File upload test passed', 'success');
            } catch (error) {
                statusDiv.innerHTML = `<span class="status-error">‚ùå File upload error: ${error.message}</span>`;
                window.debugLog(`‚ùå File upload error: ${error.message}`, 'error');
            }
        };

        // Clear log function
        window.clearLog = function() {
            document.getElementById('debugLog').innerHTML = '';
        };

        // Auto-run system check on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                window.checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html>